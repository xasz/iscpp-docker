services:
  iscpp-db:
    image: postgres:16
    container_name: iscpp-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${ISCPP_DB_USERNAME}
      POSTGRES_PASSWORD: ${ISCPP_DB_PASSWORD}
      POSTGRES_DB: ${ISCPP_DB_DATABASE}
    ports:
      - "${ISCPP_DB_PORT:-5432}:5432"
    volumes:
      - iscpp-db:/var/lib/postgresql/data

  iscpp-nginx:
    image: nginx:latest
    container_name: iscpp-nginx
    depends_on:
      - iscpp-app
    volumes:
      - iscpp-app:/var/www
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
    ports:
      - "${ISCPP_APP_PORT:-8080}:80"

  iscpp-app:
    build:
      context: ./docker/app
      dockerfile: Dockerfile
    container_name: iscpp-app
    restart: unless-stopped
    depends_on:
      - iscpp-db
    volumes:
      - iscpp-app:/var/www
      - ./docker/ca.crt:/usr/local/share/ca-certificates/ca.crt:ro
    environment:
      ISCPP_APP_KEY: "${ISCPP_APP_KEY:-}"
      ISCPP_APP_DEBUG: ${ISCPP_APP_DEBUG:-false}
      ISCPP_APP_ENV: ${ISCPP_APP_ENV:-production}
      ISCPP_APP_URL: ${ISCPP_APP_URL:-http://localhost:8080}
      ISCPP_DB_CONNECTION: ${ISCPP_DB_CONNECTION:-pgsql}
      ISCPP_DB_HOST: iscpp-db
      ISCPP_DB_PORT: ${ISCPP_DB_PORT:-5432}
      ISCPP_DB_DATABASE: ${ISCPP_DB_DATABASE}
      ISCPP_DB_USERNAME: ${ISCPP_DB_USERNAME}
      ISCPP_DB_PASSWORD: ${ISCPP_DB_PASSWORD}
      ISCPP_BRANCH: ${ISCPP_BRANCH:-main}
      ISCPP_USER_DEFAULT_TIMEZONE: ${ISCPP_USER_DEFAULT_TIMEZONE:-'Europe/Berlin'}
      ISCPP_AUTO_UPDATE: ${ISCPP_AUTO_UPDATE:-0}
      ISCPP_CA_IMPORT: ${ISCPP_CA_IMPORT:-0}
      ISCPP_EXPOSE_CONFIG: ${ISCPP_EXPOSE_CONFIG:-0}
    entrypoint: ["sh", "/usr/local/bin/entrypoint.sh"]


  iscpp-worker:
    build:
      context: ./docker/app
      dockerfile: Dockerfile-worker
    container_name: iscpp-worker
    restart: unless-stopped
    depends_on:
      - iscpp-db
    volumes:
      - iscpp-app:/var/www
    entrypoint: ["sh", "/usr/local/bin/entrypoint-worker.sh"]


  iscpp-scheduler:
    build:
      context: ./docker/app
      dockerfile: Dockerfile-scheduler
    container_name: iscpp-scheduler
    restart: unless-stopped
    depends_on:
      - iscpp-db
    volumes:
      - iscpp-app:/var/www
    entrypoint: ["sh", "/usr/local/bin/entrypoint-scheduler.sh"]

volumes:
  iscpp-db:
  iscpp-app:
